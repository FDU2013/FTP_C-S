#include "Winsock.h"
#include "windows.h"
#include "time.h"
#include "stdio.h"
#include <iostream>
using namespace std;

#define RECV_PORT 3312	//????
#define SEND_PORT 4302	//????
#pragma comment(lib, "wsock32.lib")	//??ws2_32.dll???Windows Sockets??????? ????Internet????????

SOCKET sockClient;		//?????
sockaddr_in serverAddr;	//?????
char inputIP[20];		//????????IP
char fileName[20];		//???
char rbuff[1024];		//?????
char sbuff[1024];		//?????
bool checkFlag = false;			//????????

//***********************????***********************
DWORD startSock();							//??winsock????
DWORD createSocket();						//??socket
DWORD callServer();							//??????

void help();								//??
void list(SOCKET sockfd);					//????????
DWORD sendTCP(char data[]);					//????????????
int user();									//?????
int pass();									//????
int sendFile(SOCKET datatcps, FILE* file);	//put ?????????
//***********************????***********************


//***********************????***********************
DWORD startSock() { //??winsock????
	WSADATA WSAData;
	char a[20];
	memset(a, 0, sizeof(a));
	if (WSAStartup(MAKEWORD(2, 2), &WSAData) != 0) { //??winsock??
		cout << "sock?????" << endl;
		return -1;
	}
	if (strncmp(inputIP, a, sizeof(a)) == 0) {
		cout << "??????????IP?";
		cin >> inputIP;
	}
	//??????
	serverAddr.sin_family = AF_INET;					//?????????????????????AF_INET???? TCP/IPv4 ???????
	serverAddr.sin_addr.s_addr = inet_addr(inputIP);	//?????IP??????????IPV4??
	serverAddr.sin_port = htons(RECV_PORT);				//??????htons???????????????
	return 1;
}
DWORD createSocket() { //??socket
	//?????????????socket()???????????????????????????fopen()?????????
	sockClient = socket(AF_INET, SOCK_STREAM, 0);//?scoket?????????????SOCKET(Socket Descriptor) //SOCK_STREAM???????:Tcp???????????????????????????????
	if (sockClient == SOCKET_ERROR) {
		cout << "??socket??" << endl;
		WSACleanup();//??Ws2_32.dll ???
		return -1;
	}
	return 1;
}
DWORD callServer() { //??????
	createSocket();
	if (connect(sockClient, (struct sockaddr*)&serverAddr, sizeof(serverAddr)) == SOCKET_ERROR) {//connect()????????????
		cout << "????" << endl;
		memset(inputIP, 0, sizeof(inputIP));
		return -1;
	}
	return 1;
}
void help() { //????
	cout << "        ___________________________________________  " << endl
		 << "       |                FTP????                |   " << endl
		 << "       | 1?get ???? [????: get ??? ]   |   " << endl
		 << "       | 2?put ???? [?????put ???]    |   " << endl
		 << "       | 3?pwd ????????????           |   " << endl
		 << "       | 4?dir ???????????             |   " << endl
		 << "       | 5?cd  ???????????             |   " << endl
		 << "       |         ??????: cd ???           |   " << endl
		 << "       |         ??????: cd ..               |   " << endl
		 << "       | 6?? ?? help ??????               |   " << endl
		 << "       | 7?quit ??FTP                           |   " << endl
		 << "       |___________________________________________|    " << endl;
}
DWORD sendTCP(char data[]) { //????????????
	int length = send(sockClient, data, strlen(data), 0);
	if (length <= 0) {
		cout << "??????????" << endl;
		closesocket(sockClient);//????socket()????????????closesocket()????????????fclose()??????????????????????
		WSACleanup();
		return -1;
	}
	return 1;
}
int sendFile(SOCKET datatcps, FILE* file) { //put ?????????
	cout << "??????…" << endl;
	memset(sbuff, '\0', sizeof(sbuff));
	while (1) { //?????????????
		int len = fread(sbuff, 1, sizeof(sbuff), file); //fread?file????sizeof(sbuff)??????sbuff????????????
		if (send(datatcps, sbuff, len, 0) == SOCKET_ERROR) {
			cout << "?????????" << endl;
			closesocket(datatcps);
			return 0;
		}
		if (len < sizeof(sbuff)) {
			break;
		}
	}
	closesocket(datatcps);
	cout << "????" << endl;
	return 1;
}
void list(SOCKET sockfd) { //????????
	int nRead;
	memset(sbuff, '\0', sizeof(sbuff));
	while (1) {
		nRead = recv(sockClient, rbuff, sizeof(rbuff), 0);
		//recv??sockClient?????????rbuff?????????????
		if (nRead == SOCKET_ERROR) {
			cout << "???????" << endl;
			exit(1);
		}
		if (nRead == 0) { //??????
			break;
		}
		//????
		rbuff[nRead] = '\0';
		cout << rbuff << endl;
	}
}
int  user() {
	char operation[10], name[20];		//??????
	char order[30] = "\0";				//?????
	char buff[80];						//?????????????order
	cout << "?????????user ?????";
	cin >> operation;
	cin >> name;
	strcat(order, operation), strcat(order, " "), strcat(order, name);
	sprintf(buff, order);
	sendTCP(buff);									//????
	recv(sockClient, rbuff, sizeof(rbuff), 0);		//???? 
	cout << rbuff << endl;
	return 1;
}
int pass() {
	char operation[10], name[20];		//??????
	char order[30] = "\0";				//?????
	char buff[80];						//?????????????order
	cout << "????????pass ????" ;
	cin >> operation;
	cin >> name;
	strcat(order, operation), strcat(order, " "), strcat(order, name);
	sprintf(buff, order);
	sendTCP(buff);									//????
	recv(sockClient, rbuff, sizeof(rbuff), 0);		//???? 
	cout << rbuff << endl;
	if (strcmp(rbuff, "wrong") == 0) {
		return 0;
	}
	return 1;
}
//***********************????***********************

int main(){
	while (1) {
		char operation[10], name[20];		//??????
		char order[30] = "\0";				//?????
		char buff[80];						//?????????????order
		FILE *fd1, *fd2;					//File??????????????????fd???????????? 
		int cnt;

		startSock();				//??winsock????
		if (callServer() == -1) {	//????????
			continue;
		}

		//??????????????
		memset(operation, 0, sizeof(operation));
		memset(name, 0, sizeof(name));
		memset(order, 0, sizeof(order));
		memset(buff, 0, sizeof(buff));
		memset(rbuff, 0, sizeof(rbuff));
		memset(sbuff, 0, sizeof(sbuff));

		if (checkFlag == false) {//??
			if (user() && pass()) {
				checkFlag = true;
				continue;
			}
			else {
				continue;
			}
		}

		cout << endl << "?????????(?? ? ? help ????????) : ";
		cin >> operation;
		
		if (strncmp(operation, "get", 3) == 0 || strncmp(operation, "put", 3) == 0 || strncmp(operation, "cd", 2) == 0) { ///??????????
			cin >> name;
		}else if (strncmp(operation, "quit", 4) == 0) { ///????
			cout << "??????" << endl;
			closesocket(sockClient);
			WSACleanup();
			break;
		}else if (strncmp(operation, "?", 1) == 0 || strncmp(operation, "help", 4) == 0) { ///??????
			help();
		}

		//??????order?????buff
		strcat(order, operation), strcat(order, " "), strcat(order, name);
		sprintf(buff, order);
		sendTCP(buff);									//????
		recv(sockClient, rbuff, sizeof(rbuff), 0);		//???? 
		cout << rbuff << endl;							//pwd?????????
		if (strncmp(rbuff, "get", 3) == 0) {			///????
			fd1 = fopen(name, "wb");					//????????????wb??????????????????????  
			if (fd1 == NULL){
				cout << "?????? "<< name << "????" << endl;
				continue;
			}
			memset(rbuff, '\0', sizeof(rbuff));
			while ((cnt = recv(sockClient, rbuff, sizeof(rbuff), 0)) > 0) {
				fwrite(rbuff, sizeof(rbuff), cnt, fd1);	//C ??? size_t fwrite(const void *ptr, size_t size, size_t nmemb, FILE *stream) ? ptr ???????????????? stream ??
			}
			fclose(fd1);								//????
		}//get
		else if (strncmp(rbuff, "put", 3) == 0) { ///????
			strcpy(fileName, rbuff + 4);
			fd2 = fopen(fileName, "rb");				//?????????????????????
			if (fd2){ //????
				if (!sendFile(sockClient, fd2)) {
					cout << "????" << endl;
					return 0;
				}
				fclose(fd2);
			}
			else{
				strcpy(sbuff, "??????\n");
				if (send(sockClient, sbuff, sizeof(sbuff), 0)) {
					return 0;
				}
			}
		}//put
		else if (strncmp(rbuff, "dir", 3) == 0) { ///dir??
			list(sockClient);
		}//dir
		closesocket(sockClient);	//????
		WSACleanup();				//??Winsock
	}
	return 0;
}
/*
192.168.0.100
user gyc
pass 123456
pwd
cd Debug
get 110.txt
*/